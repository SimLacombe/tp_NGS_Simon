---
title: "NGS_script_week2"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r library}
library(Seurat)
library(tximport)
library( magrittr)
```



```{r load and format data}
samps <- c("SRR8257100","SRR8257101","SRR8257102","SRR8257103",
           "SRR8257104","SRR8257105","SRR8257106")
files <- file.path(
  paste("/home/rstudio/mydatalocal/tp_NGS_Simon/data/data_total/quant/",samps,"/alevin/quants_mat.gz", sep=""))
file.exists(files)

txis <- lapply(files, function(f) tximport(files = f, type="alevin"))

seu_objs <- lapply(seq_along(txis), function(i){
  s <- CreateSeuratObject(counts = txis[[i]]$counts , min.cells = 3, min.features = 200, project = samps[i]) 
  })

scarabWT_ <- merge(x = seu_objs[[1]], y = unlist(seu_objs[2:4], recursive = F), add.cell.ids = samps[1:4])
```

```{r analysis of Seurat count matrix}
scarabWT_[["percent.mt"]] <- PercentageFeatureSet(scarabWT_, pattern = "ATM")
scarabWT_[["percent.chloro"]] <- PercentageFeatureSet(scarabWT_, pattern = "ATC")

VlnPlot(scarabWT_, features = c("nFeature_RNA", "nCount_RNA", "percent.mt", "percent.chloro"), ncol = 4)
```
```{r prepare data}
thr_mt <- quantile(scarabWT_[["percent.mt"]]$percent.m, 0.95)
thr_chloro <- 0.2

scarabWT <- subset(scarabWT_, subset = percent.mt < thr_mt & percent.chloro < thr_chloro)

VlnPlot(scarabWT, features = c("percent.mt", "percent.chloro"), ncol = 4)
ncell.table <- table(scarabWT$orig.ident) 
ncell.table

scarabWT <- NormalizeData(scarabWT, normalization.method = "LogNormalize", scale.factor = 10000)
scarabWT <- FindVariableFeatures(scarabWT, selection.method = "vst", nfeatures = 5000)

all.genes <- rownames(scarabWT)
scarabWT <- ScaleData(scarabWT, features = all.genes)

```


```{r message = FALSE, warning=FALSE, pca }
scarabWT <- RunPCA(scarabWT, features = VariableFeatures(object = scarabWT))
```

```{r}
VizDimLoadings(scarabWT, dims = 1:2, reduction = "pca")
DimPlot(scarabWT, reduction = "pca")
DimHeatmap(scarabWT, dims = 1, cells = 500, balanced = TRUE)
```


```{r}
#scarabWT <- JackStraw(scarabWT, num.replicate = 100)
#scarabWT <- ScoreJackStraw(scarabWT, dims = 1:20)
```
```{r}
JackStrawPlot(scarabWT, dims = 1:15)
```
```{r}
scarabWT <- FindNeighbors(scarabWT, dims = 1:10)
scarabWT <- FindClusters(scarabWT, resolution = .5)
head(Idents(scarabWT), 5)
```
```{r}
scarabWT <- RunUMAP(scarabWT, dims = 1:10)
DimPlot(scarabWT, reduction = "umap")
```

